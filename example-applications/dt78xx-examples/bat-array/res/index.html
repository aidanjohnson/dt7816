<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Signal Analyzer</title>
<!-- Set the viewport width to device width for mobile -->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style> 
    div {text-align: center;} 
	html, body 
	{
		width: 100%;
		height: 100%;
		margin: 0px;
		border: 0;
		overflow: hidden; /*  Disable scrollbars */
		display: block;  /* No floating content on sides */
	}
	#boardname {font-size: 16pt; color: blue; font-family: arial; font-weight:bold;}
</style>
<script type="text/javascript" src="dtgraph.js"></script>
<script type="text/javascript">
	var WAVEFORM_MAX_X = 1000; //1000 samples @ 100KHz == 10ms
	var SPECTRUM_MAX_X = (1024/2); 
	var ws_spectrum=null; //web socket to handle FFT spectrum display
	var ws_waveform=null; //web socket to display waveforms
	var waveform_canvas, spectrum_canvas;
	var logo_height=0;
	var waveform_chart=null;
	var spectrum_chart=null;
	var actual_sample_rate;

	window.onload = function() 
	{
		var img = new Image();
		img.src = "dtlogo.png";
		img.onload = function()
		{
			logo_height = img.height;
			console.log("logo_height ", logo_height);
			resize_canvas();
		};
		waveform_canvas=document.getElementById('waveform_plot');
		var waveform_ctx = waveform_canvas.getContext('2d');
		spectrum_canvas=document.getElementById('spectrum_plot');
		var spectrum_ctx = spectrum_canvas.getContext('2d');
		//Graph to plot single channel voltage. Actual configuration set by
		//XMLHttpRequest() to URL /samplerate.get
		waveform_chart = new Graph({
							canvasId: 'waveform_plot',
							title:'Analog inputs',
							plots:[new Plot({maxIndex:WAVEFORM_MAX_X,lineColor:'#ff0000',
											lineWidth:1,legend:'AIN0'})
								  ],
							XAxis:new Axis({min:0,max:WAVEFORM_MAX_X,tickSpacing:100,
											minValue:0, maxValue:10,
											label:'ms', drawGrid:'true'}),
							YAxis:new Axis({min:-10,max:10,tickSpacing:1,
											label:'Volt', drawGrid:'true'})
						  });
		//Graph to plot single channel spectrum.Actual configuration set by
		//XMLHttpRequest() to URL /samplerate.get
		spectrum_chart = new Graph({
							canvasId: 'spectrum_plot',
							title:'Spectrum',
							plots:[new Plot({maxIndex:SPECTRUM_MAX_X,lineColor:'#ff0000',
											lineWidth:1,legend:'AIN0'})
								  ],
							XAxis:new Axis({min:0,max:SPECTRUM_MAX_X,tickSpacing:32,
											minValue:0, maxValue:50000,
											label:'Hz', drawGrid:'true'}),
							YAxis:new Axis({min:-140,max:0,tickSpacing:10,
											label:'dB', drawGrid:'true'})
						  });

		//AJAX request to get the actual board type
		var xhr = new XMLHttpRequest();
		xhr.open('GET', '/boardname.get', true);
		xhr.responseType = 'text';
		xhr.onload = function(e) 
		{
		  if (this.status === 200) 
		  {
			document.getElementById('boardname').innerHTML = this.response;
			document.title = this.response + ' Signal Analyzer';
		  }
		};
		xhr.send();	
		
		//AJAX request to get the actual sample rate
		var xhr2 = new XMLHttpRequest();
		xhr2.open('GET', '/samplerate.get', true);
		xhr2.responseType = 'arraybuffer';
		xhr2.onload = function(e) 
		{
		  if (this.status === 200) 
		  {
			var buffer = this.response;
			var sample_rate   = new Float32Array(buffer);
			actual_sample_rate = sample_rate[0];
			var nyquist = sample_rate[0]/2;
			//time in ms
			var time = (waveform_chart.XAxis.max*1000)/actual_sample_rate;
			//re configure both charts
			spectrum_chart.XAxis.maxValue = nyquist.toString();
			waveform_chart.XAxis.maxValue = time.toString();
			resize_canvas();
		  }
		};
		xhr2.send();	   
	   
	//web socket to receive and display the spectrum data   
	if (ws_spectrum===null) 
	{
		ws_spectrum = new WebSocket('ws://' + location.host + '/spectrum.get');
		ws_spectrum.binaryType = "arraybuffer";
		ws_spectrum.onopen = function(ev) 
		{
			//console.log("ws_spectrum open");
		};
		ws_spectrum.onclose = function(ev) 
		{
			//console.log("ws_spectrum onclose");
			ws_spectrum = null;
		};
		ws_spectrum.onmessage = function(ev) 
		{
			//console.log("ws_spectrum onmessage");
			if (!ev.data) return;
			var buffer = ev.data;
			//parse the header which is struct ws_buffer
			var type = new Int32Array(buffer, 0, 1);
			var num_samples = new Int32Array(buffer, 4, 1);
			if (num_samples[0] < SPECTRUM_MAX_X)
				console.log("Insufficient num_sample "+num_samples[0] );
			else
				num_samples[0] = SPECTRUM_MAX_X;
			var mag = new Float32Array(buffer, 8, num_samples[0]);
			//find the maximum spectral amplitude and frequency bin
			var max = mag[0];
			var max_idx = 0;
			for (var i=0; i < num_samples[0]; i++)
			{
				spectrum_chart.plots[0].value[i]=mag[i];
				if (mag[i] > max)
				{
					max = mag[i];
					max_idx = i;
				}
			}
			//Set the X marker to show maximum spectral amplitude and frequency
			var max_freq = spectrum_chart.XAxis.maxValue*(max_idx/spectrum_chart.XAxis.max);
			spectrum_chart.update(max_idx, 
								max_freq.toString().slice(0,5)+'Hz '+
								max.toString().slice(0,5)+'dB');
		};
		ws_spectrum.onerror = function(ev) 
		{
			console.log("ws_spectrum onerror");
		};	
	}
	//web socket to receive and display voltage waveform
	if (ws_waveform===null) 
	{
		ws_waveform = new WebSocket('ws://' + location.host + '/waveform.get');
		ws_waveform.binaryType = "arraybuffer";
		ws_waveform.onopen = function(ev) 
		{
			//console.log("ws_waveform onopen");
		};
		ws_waveform.onclose = function(ev) 
		{
			//console.log("ws_waveform onclose");
			ws_waveform = null;
		};
		//data received from board
		ws_waveform.onmessage = function(ev) 
		{
			//console.log("ws_waveform onmessage");
			if (!ev.data) return;
			var buffer = ev.data;
			//parse the header which is struct ws_buffer
			var type = new Int32Array(buffer, 0, 1);
			var num_samples = new Int32Array(buffer, 4, 1);
			if (num_samples[0] < WAVEFORM_MAX_X)
				console.log("Insufficient num_sample "+num_samples[0] );
			else
				num_samples[0] = WAVEFORM_MAX_X;
			var volt = new Float32Array(buffer, 8, num_samples[0]);
			//find minimum and maximum values
			var min = volt[0];
			var max = min;
			for (var i=0; i < num_samples[0]; i++)
			{
				waveform_chart.plots[0].value[i]=volt[i];
				if (min > volt[i]) min = volt[i];
				if (max < volt[i]) max = volt[i];
			}
			//Display the max and min values
			waveform_chart.update(0, max.toString().slice(0,8)+'V ' +
									min.toString().slice(0,8)+'V');
		};
		ws_waveform.onerror = function(ev) 
		{
			console.log("ws_waveform onerror");
		};	
	}
	};//window.onload = function()
   
	function resize_canvas()
	{
		var bottomPad = Math.round(window.innerHeight*0.01);
		waveform_canvas.width= window.innerWidth;
		waveform_canvas.height= (window.innerHeight-logo_height)/2-bottomPad;
		waveform_chart.resize();
		spectrum_canvas.width= window.innerWidth;
		spectrum_canvas.height= waveform_canvas.height;
		spectrum_chart.resize();
	}
	window.onresize = function()
	{
		resize_canvas();
	};
</script>
</head>
<body>
    <div id="top">
	<a href="http://www.datatranslation.com" target="_blank">
	    <img src="dtlogo.png" id="logo" style="float:left;"
	    alt="Click for Data Translation website" border="0" />
	</a>
        <span id="boardname">DT7837</span>
    </div>
    <canvas id="waveform_plot"></canvas>
    <canvas id="spectrum_plot"></canvas>
</body>
</html>
